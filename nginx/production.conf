worker_processes 2;

events {
	use epoll;
	worker_connections 1024;
}

error_log /var/log/nginx/error.log;

http {
    # first we declare our upstream server, which is our uvicorn application
    upstream backend_server {
        # docker will automatically resolve this to the correct address
        # because we use the same name as the service
        server web:8000;
    }



	server_tokens off;
	include mime.types;
	charset utf-8;

    server {
        listen 443 ssl;
		server_name localhost;
        ssl_certificate     /etc/nginx/certificates/server.crt;
        ssl_certificate_key /etc/nginx/certificates/server.key;

        root /usr/share/nginx/html;
        index index.html;
        
        location / {
            try_files $uri $uri/ @rewrites;
        }

        location @rewrites {
            rewrite ^(.+)$ /index.html last;
        }

		location /backend/ {
			proxy_pass https://backend_server; # указанный порт должен соответствовать порту сервера Uvicorn
			proxy_set_header Host $host; # передаем заголовок Host, содержащий целевой IP и порта сервера.
			proxy_set_header X-Real-IP $remote_addr; # передаем заголовок с IP-адресом пользователя
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # передаем всю последовательность адресов, через которые прошел запрос
		}
	}
}